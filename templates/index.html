<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doom-scrolling Storyteller</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Terminal.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='terminal.css') }}">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5><i class="fas fa-magic"></i> Story Controls</h5>
            <button class="btn btn-sm btn-outline-light d-md-none" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Story Mode Toggle -->
        <div class="story-mode-section">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="mode-label">Free Mode</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="storyModeToggle" onchange="toggleStoryMode()">
                    <label class="form-check-label visually-hidden" for="storyModeToggle">Story Mode Toggle</label>
                </div>
                <span class="mode-label guided-label" style="opacity: 0.5;">Guided Mode</span>
            </div>
            <small class="text-muted mode-description" id="modeDescription">
                Infinite scroll continues story automatically
            </small>
        </div>

        <!-- Story Influences Section -->
        <div class="influence-section">
            <h5 class="section-title">
                <i class="fas fa-chevron-down" id="influences-icon"></i>
                Story Influences
            </h5>
            <div class="section-content" id="influences-content">
                <h6 class="section-category">Mood</h6>
                <div class="badge-container" id="mood-badges">
                    <!-- Mood badges will be populated here -->
                </div>

                <h6 class="section-category">Genre</h6>
                <div class="badge-container" id="genre-badges">
                    <!-- Genre badges will be populated here -->
                </div>

                <h6 class="section-category">Style</h6>
                <div class="badge-container" id="intensity-badges">
                    <!-- Style badges will be populated here -->
                </div>

                <h6 class="section-category">üå∂Ô∏è Spicy</h6>
                <div class="badge-container" id="spicy-badges">
                    <!-- Spicy badges will be populated here -->
                </div>
            </div>
        </div>

        <!-- Character Section -->
        <div class="influence-section">
            <h5 class="section-title">
                <i class="fas fa-chevron-down" id="characters-icon"></i>
                Character Elements
            </h5>
            <div class="section-content" id="characters-content">
                <h6 class="section-category">Types</h6>
                <div class="badge-container" id="archetypes-characters">
                    <!-- Character type badges will be populated here -->
                </div>

                <h6 class="section-category">Traits</h6>
                <div class="badge-container" id="traits-characters">
                    <!-- Character trait badges will be populated here -->
                </div>

                <h6 class="section-category">Relations</h6>
                <div class="badge-container" id="relationships-characters">
                    <!-- Character relationship badges will be populated here -->
                </div>
            </div>
        </div>

        <!-- Add New Badge -->
        <div class="add-badge-section">
            <h6>Add New Influence</h6>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="newBadgeInput" placeholder="e.g. spooky, cheerful">
                <button class="btn btn-outline-light" type="button" onclick="addNewBadge()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Reset Story -->
        <div class="reset-section">
            <button class="btn btn-outline-danger btn-sm" onclick="resetStory()">
                <i class="fas fa-refresh"></i> New Story
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Mobile sidebar toggle -->
        <button class="sidebar-toggle btn btn-primary d-md-none" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Header -->
        <header class="text-center py-4">
            <h1><i class="fas fa-scroll"></i> Doom-scrolling Storyteller</h1>
            <p class="text-muted">Toggle influences in the sidebar and scroll to continue your story</p>
        </header>

        <!-- Story Content -->
        <div class="story-container" id="storyContainer">
            <div class="story-segment loading-segment" id="loadingSegment">
                <div class="text-center">
                    <div class="start-story-section">
                        <h3><i class="fas fa-magic"></i> Ready to Begin Your Adventure?</h3>
                        <p class="mb-4">Select story influences and character elements from the sidebar, then click below to generate your personalized story.</p>

                        <button class="btn btn-primary btn-lg" id="startStoryBtn" onclick="startStory()">
                            <i class="fas fa-play-circle"></i> Generate Story
                        </button>

                        <div class="mt-4 text-muted small">
                            <p><i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Try different combinations of influences for unique stories!</p>
                        </div>
                    </div>

                    <!-- Hidden loading state -->
                    <div class="generating-story-section" id="generatingStory" style="display: none;">
                        <div class="terminal-loader">
                            <div class="terminal-cursor"></div>
                            <div class="loading-dots">
                                <span>></span>
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                            </div>
                        </div>
                        <p class="loading-message" id="loadingMessage">Crafting your story...</p>
                        <p class="loading-submessage" id="loadingSubmessage">This may take a few moments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storyline Selection Panel -->
        <div class="storyline-selection-panel" id="storylinePanel" style="display: none;">
            <div class="panel-content">
                <div class="panel-header text-center mb-4">
                    <h4><i class="fas fa-route"></i> Choose Your Path</h4>
                    <p class="text-muted">Select which direction the story should take next</p>
                </div>

                <div class="storyline-options" id="storylineOptions">
                    <!-- Storyline options will be populated here -->
                </div>

                <div class="panel-loading text-center" id="storylineLoading" style="display: none;">
                    <div class="terminal-loader">
                        <div class="terminal-cursor"></div>
                        <div class="loading-dots">
                            <span>></span>
                            <span class="dot">.</span>
                            <span class="dot">.</span>
                            <span class="dot">.</span>
                        </div>
                    </div>
                    <p class="loading-message">Generating storyline options...</p>
                </div>
            </div>
        </div>

        <!-- Scroll Trigger Area -->
        <div class="scroll-trigger" id="scrollTrigger">
            <div class="text-center py-4">
                <div class="terminal-loader" style="display: none;" id="continueLoader">
                    <div class="terminal-cursor"></div>
                    <div class="loading-dots">
                        <span>></span>
                        <span class="dot">.</span>
                        <span class="dot">.</span>
                        <span class="dot">.</span>
                    </div>
                </div>
                <p class="scroll-message" id="scrollMessage">Keep scrolling for more story...</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        let activeBadges = new Set();
        let activeCharacters = new Set();
        let allBadges = {};
        let allCharacters = {};
        let currentBadgeCategory = 'mood';
        let currentCharacterCategory = 'archetypes';
        let isLoading = false;
        let hasStarted = false;
        let storyMode = 'free'; // 'free' or 'guided'
        let pendingStorylines = [];
        let awaitingSelection = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadBadges();
            loadCharacters();
            loadStoryMode();
            setupScrollListener();
        });

        // Load current story mode from server
        async function loadStoryMode() {
            try {
                const response = await fetch('/api/get_story_mode');
                const data = await response.json();
                storyMode = data.story_mode || 'free';
                updateModeToggle();
            } catch (error) {
                console.error('Error loading story mode:', error);
                storyMode = 'free';
                updateModeToggle();
            }
        }

        // Toggle story mode between free and guided
        async function toggleStoryMode() {
            const toggle = document.getElementById('storyModeToggle');
            const newMode = toggle.checked ? 'guided' : 'free';

            try {
                const response = await fetch('/api/set_story_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mode: newMode
                    })
                });

                const data = await response.json();
                if (data.success) {
                    storyMode = newMode;
                    updateModeToggle();

                    // Clear any pending storylines when switching modes
                    awaitingSelection = false;
                    hideStorylinePanel();

                    console.log(`Story mode changed to: ${storyMode}`);
                } else {
                    console.error('Failed to change story mode:', data.error);
                    // Revert toggle on error
                    toggle.checked = storyMode === 'guided';
                }
            } catch (error) {
                console.error('Error changing story mode:', error);
                // Revert toggle on error
                toggle.checked = storyMode === 'guided';
            }
        }

        // Update mode toggle display
        function updateModeToggle() {
            const toggle = document.getElementById('storyModeToggle');
            const modeDescription = document.getElementById('modeDescription');
            const freeLabel = document.querySelector('.mode-label:not(.guided-label)');
            const guidedLabel = document.querySelector('.guided-label');

            toggle.checked = storyMode === 'guided';

            if (storyMode === 'guided') {
                modeDescription.textContent = 'Choose storyline options before continuing';
                freeLabel.style.opacity = '0.5';
                guidedLabel.style.opacity = '1';
            } else {
                modeDescription.textContent = 'Infinite scroll continues story automatically';
                freeLabel.style.opacity = '1';
                guidedLabel.style.opacity = '0.5';
            }
        }

        // Load badges from server
        async function loadBadges() {
            console.log('loadBadges called');
            try {
                const response = await fetch('/api/get_badges');
                const data = await response.json();
                console.log('Server response:', data);

                // Check if server returns categorized object or flat array
                if (data.badges && typeof data.badges === 'object' && !Array.isArray(data.badges)) {
                    // Server returned categorized object
                    allBadges = data.badges;
                    console.log('Using categorized badges from server:', allBadges);
                } else {
                    // Server returned flat array or unexpected format, use fallback structure
                    console.log('Server returned flat array, using fallback categorized structure');
                    allBadges = {
                        mood: ['mysterious', 'romantic', 'funny', 'dark'],
                        genre: ['sci-fi', 'fantasy', 'horror'],
                        intensity: ['action-packed', 'slow-burn'],
                        spicy: ['passionate', 'dangerous']
                    };
                }
                renderCurrentBadges();
            } catch (error) {
                console.error('Error loading badges:', error);
                // Fallback badges
                allBadges = {
                    mood: ['mysterious', 'romantic', 'funny', 'dark'],
                    genre: ['sci-fi', 'fantasy', 'horror'],
                    intensity: ['action-packed', 'slow-burn'],
                    spicy: ['passionate', 'dangerous']
                };
                console.log('Using fallback badges:', allBadges);
                renderCurrentBadges();
            }
        }

        // Load characters from server
        async function loadCharacters() {
            try {
                const response = await fetch('/api/get_characters');
                const data = await response.json();
                allCharacters = data.characters;
                renderCurrentCharacters();
            } catch (error) {
                console.error('Error loading characters:', error);
                allCharacters = {
                    archetypes: ['hero', 'villain', 'mentor'],
                    traits: ['mysterious stranger', 'reluctant hero'],
                    relationships: ['enemies-to-lovers', 'rivals']
                };
                renderCurrentCharacters();
            }
        }

        // Render all badge categories
        function renderCurrentBadges() {
            console.log('renderCurrentBadges called, allBadges:', allBadges);
            Object.keys(allBadges).forEach(category => {
                const containerId = `${category}-badges`;
                const container = document.getElementById(containerId);
                console.log(`Looking for container: ${containerId}, found:`, container);

                if (!container) {
                    console.error(`Container not found: ${containerId}`);
                    return;
                }

                container.innerHTML = '';
                const badges = allBadges[category] || [];
                console.log(`Rendering badges for ${category}:`, badges);

                badges.forEach(badge => {
                    const badgeElement = document.createElement('span');
                    badgeElement.className = `badge story-badge category-${category}`;
                    if (activeBadges.has(badge)) {
                        badgeElement.classList.add('active');
                    }
                    badgeElement.textContent = badge;
                    badgeElement.onclick = () => toggleBadge(badge, badgeElement);
                    container.appendChild(badgeElement);
                });
                console.log(`Added ${badges.length} badges to ${containerId}`);
            });
        }

        // Render all character categories
        function renderCurrentCharacters() {
            Object.keys(allCharacters).forEach(category => {
                const container = document.getElementById(`${category}-characters`);
                if (!container) return;

                container.innerHTML = '';
                const characters = allCharacters[category] || [];
                characters.forEach(character => {
                    const characterElement = document.createElement('span');
                    characterElement.className = `badge character-badge category-${category}`;
                    if (activeCharacters.has(character)) {
                        characterElement.classList.add('active');
                    }
                    characterElement.textContent = character;
                    characterElement.onclick = () => toggleCharacter(character, characterElement);
                    container.appendChild(characterElement);
                });
            });
        }



        // Toggle badge active state
        function toggleBadge(badge, element) {
            if (activeBadges.has(badge)) {
                activeBadges.delete(badge);
                element.classList.remove('active');
            } else {
                activeBadges.add(badge);
                element.classList.add('active');
            }
        }

        // Toggle character active state
        function toggleCharacter(character, element) {
            if (activeCharacters.has(character)) {
                activeCharacters.delete(character);
                element.classList.remove('active');
            } else {
                activeCharacters.add(character);
                element.classList.add('active');
            }
        }

        // Toggle section expand/collapse
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }

        // Add new badge
        async function addNewBadge() {
            const input = document.getElementById('newBadgeInput');
            const badge = input.value.trim();

            if (!badge) return;

            try {
                const response = await fetch('/api/add_badge', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({badge: badge})
                });

                const data = await response.json();
                if (data.success) {
                    // Reload badges to show new badge in appropriate category
                    loadBadges();
                    input.value = '';
                } else {
                    alert(data.error || 'Failed to add badge');
                }
            } catch (error) {
                console.error('Error adding badge:', error);
                alert('Failed to add badge');
            }
        }

        // Start initial story
        async function startStory() {
            if (isLoading || hasStarted) return;

            isLoading = true;
            hasStarted = true;

            // Hide start section and show generating section
            document.querySelector('.start-story-section').style.display = 'none';
            document.getElementById('generatingStory').style.display = 'block';

            // Update loading message based on selected influences
            const totalInfluences = activeBadges.size + activeCharacters.size;
            if (totalInfluences === 0) {
                updateInitialLoadingMessage('Creating a mysterious tale...', 'No influences selected - letting creativity flow freely');
            } else if (totalInfluences <= 3) {
                const influences = [...Array.from(activeBadges), ...Array.from(activeCharacters)];
                updateInitialLoadingMessage('Crafting your personalized story...', `Incorporating ${totalInfluences} influence${totalInfluences > 1 ? 's' : ''}: ${influences.join(', ')}`);
            } else {
                updateInitialLoadingMessage('Weaving a complex narrative...', `Blending ${totalInfluences} influences for maximum storytelling depth`);
            }

            try {
                const response = await fetch('/api/start_story', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        active_badges: Array.from(activeBadges),
                        active_characters: Array.from(activeCharacters)
                    })
                });

                const data = await response.json();
                if (data.success) {
                    displayStorySegment(data.segment, data.segment_number, null, data.think_sections || [], data.image_url);
                } else {
                    throw new Error('Failed to start story');
                }
            } catch (error) {
                console.error('Error starting story:', error);
                displayError('Failed to generate story. Please check your API key and try again.');
            } finally {
                isLoading = false;
            }
        }

        // Continue story
        async function continueStory() {
            console.log('continueStory() called');
            if (isLoading || !hasStarted) {
                console.log('Skipping continueStory - isLoading:', isLoading, 'hasStarted:', hasStarted);
                return;
            }

            // In guided mode, show storyline options instead of generating directly
            if (storyMode === 'guided') {
                await showStorylineOptions();
                return;
            }

            console.log('Setting loading state and starting continue story request');
            isLoading = true;
            showLoadingSpinner(true);

            try {
                console.log('Sending continue_story request with badges:', Array.from(activeBadges), 'and characters:', Array.from(activeCharacters));
                const response = await fetch('/api/continue_story', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        active_badges: Array.from(activeBadges),
                        active_characters: Array.from(activeCharacters)
                    })
                });

                const data = await response.json();
                console.log('Continue story response:', data);
                if (data.success) {
                    console.log(`Displaying segment ${data.segment_number}`);
                    displayStorySegment(data.segment, data.segment_number, null, data.think_sections || [], data.image_url);
                } else {
                    console.error('Continue story failed:', data.error || 'Unknown error');
                    if (data.error && data.error.includes('No existing story found')) {
                        // Session was lost, reload page to start fresh
                        console.log('Session lost, reloading page...');
                        window.location.reload();
                        return;
                    }
                    throw new Error(data.error || 'Failed to continue story');
                }
            } catch (error) {
                console.error('Error continuing story:', error);
                displayError('Failed to generate next story segment. Please try again.');
            } finally {
                console.log('Continue story request completed, clearing loading state');
                isLoading = false;
                showLoadingSpinner(false);
            }
        }

        // Show storyline options for guided mode
        async function showStorylineOptions() {
            if (awaitingSelection) {
                console.log('Already awaiting storyline selection');
                return;
            }

            awaitingSelection = true;
            showStorylineLoadingPanel(true);

            try {
                console.log('Generating storyline options...');
                const response = await fetch('/api/get_storyline_options', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        active_badges: Array.from(activeBadges),
                        active_characters: Array.from(activeCharacters)
                    })
                });

                const data = await response.json();
                if (data.success) {
                    pendingStorylines = data.storyline_options;
                    displayStorylineOptions(data.storyline_options);
                } else {
                    console.error('Failed to generate storyline options:', data.error);
                    throw new Error(data.error || 'Failed to generate storyline options');
                }
            } catch (error) {
                console.error('Error generating storyline options:', error);
                displayError('Failed to generate storyline options. Please try again.');
                awaitingSelection = false;
                hideStorylinePanel();
            } finally {
                showStorylineLoadingPanel(false);
            }
        }

        // Display storyline options for user selection
        function displayStorylineOptions(options) {
            const optionsContainer = document.getElementById('storylineOptions');
            optionsContainer.innerHTML = '';

            options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'storyline-option';
                optionElement.innerHTML = `
                    <div class="option-header">
                        <h6 class="option-title">${option.title}</h6>
                    </div>
                    <div class="option-description">
                        ${option.description}
                    </div>
                    <button class="btn btn-primary btn-sm mt-2" onclick="selectStoryline(${index})">
                        <i class="fas fa-arrow-right"></i> Choose This Path
                    </button>
                `;
                optionsContainer.appendChild(optionElement);
            });

            showStorylinePanel();
        }

        // Select a storyline option and generate next segment
        async function selectStoryline(selectedIndex) {
            if (!pendingStorylines || selectedIndex < 0 || selectedIndex >= pendingStorylines.length) {
                console.error('Invalid storyline selection:', selectedIndex);
                return;
            }

            const selectedOption = pendingStorylines[selectedIndex];
            console.log('Selected storyline:', selectedOption);

            // Show loading state
            hideStorylinePanel();
            isLoading = true;
            showLoadingSpinner(true);

            try {
                const response = await fetch('/api/select_storyline', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        selected_index: selectedIndex,
                        active_badges: Array.from(activeBadges),
                        active_characters: Array.from(activeCharacters)
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`Displaying storyline-based segment ${data.segment_number}`);
                    displayStorySegment(data.segment, data.segment_number, data.selected_storyline, data.think_sections || [], data.image_url);

                    // Clear storyline state
                    pendingStorylines = [];
                    awaitingSelection = false;
                } else {
                    console.error('Failed to select storyline:', data.error);
                    throw new Error(data.error || 'Failed to select storyline');
                }
            } catch (error) {
                console.error('Error selecting storyline:', error);
                displayError('Failed to generate story with selected storyline. Please try again.');
                awaitingSelection = false;
            } finally {
                isLoading = false;
                showLoadingSpinner(false);
            }
        }

        // Show/hide storyline selection panel
        function showStorylinePanel() {
            const panel = document.getElementById('storylinePanel');
            panel.style.display = 'block';
            panel.scrollIntoView({behavior: 'smooth', block: 'center'});
        }

        function hideStorylinePanel() {
            const panel = document.getElementById('storylinePanel');
            panel.style.display = 'none';
        }

        function showStorylineLoadingPanel(show) {
            const loadingElement = document.getElementById('storylineLoading');
            const optionsElement = document.getElementById('storylineOptions');

            if (show) {
                loadingElement.style.display = 'block';
                optionsElement.style.display = 'none';
                showStorylinePanel();
            } else {
                loadingElement.style.display = 'none';
                optionsElement.style.display = 'block';
            }
        }

        // Convert text with newlines to properly formatted HTML and handle think placeholders
        function formatStoryText(text, thinkSections = []) {
            let processedText = text
                // Convert markdown headers (### Title) to HTML headers
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                // Convert double newlines (paragraphs) to paragraph tags
                .replace(/\n\n+/g, '</p><p>')
                // Convert single newlines to line breaks
                .replace(/\n/g, '<br>')
                // Wrap in paragraph tags if content doesn't start with a header
                .replace(/^(?!<h3>)/, '<p>')
                // Close final paragraph if needed
                .replace(/(?<!<\/h3>)$/, '</p>')
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '');

            // Replace think placeholders with accordion HTML
            if (thinkSections && thinkSections.length > 0) {
                thinkSections.forEach(thinkSection => {
                    const placeholder = `__THINK_PLACEHOLDER_${thinkSection.id}__`;
                    const accordionHtml = createThinkAccordion(thinkSection);
                    processedText = processedText.replace(placeholder, accordionHtml);
                });
            }

            return processedText;
        }

        // Create accordion HTML for think section
        function createThinkAccordion(thinkSection) {
            const accordionId = `accordion_${thinkSection.id}`;
            const collapseId = `collapse_${thinkSection.id}`;

            // Format think content (preserve line breaks but don't add paragraph tags)
            const formattedContent = thinkSection.content
                .replace(/\n/g, '<br>')
                .trim();

            return `
                <div class="think-accordion" id="${accordionId}">
                    <div class="accordion-header" data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                         aria-expanded="false" aria-controls="${collapseId}">
                        <div class="accordion-header-content">
                            <i class="fas fa-brain"></i>
                            <span class="accordion-title">AI Thinking Process</span>
                            <i class="fas fa-chevron-down accordion-icon"></i>
                        </div>
                    </div>
                    <div id="${collapseId}" class="accordion-collapse collapse"
                         aria-labelledby="${accordionId}" data-bs-parent="#${accordionId}">
                        <div class="accordion-body">
                            ${formattedContent}
                        </div>
                    </div>
                </div>
            `;
        }

        // Display story segment
        function displayStorySegment(segment, segmentNumber, selectedStoryline = null, thinkSections = [], imageUrl = null) {
            const container = document.getElementById('storyContainer');

            // Hide loading segment on first story
            if (segmentNumber === 1) {
                const loadingSegment = document.getElementById('loadingSegment');
                if (loadingSegment) {
                    loadingSegment.style.display = 'none';
                }
            }

            // Create new segment element
            const segmentElement = document.createElement('div');
            segmentElement.className = 'story-segment';
            // Build influences display
            const influences = [];
            if (activeBadges.size > 0) {
                influences.push(`Story: ${Array.from(activeBadges).join(', ')}`);
            }
            if (activeCharacters.size > 0) {
                influences.push(`Characters: ${Array.from(activeCharacters).join(', ')}`);
            }

            // Add selected storyline info if available
            let storylineInfo = '';
            if (selectedStoryline) {
                storylineInfo = `<div class="selected-storyline-info">
                    <i class="fas fa-route"></i> <strong>Chosen Path:</strong> ${selectedStoryline.title}
                </div>`;
            }

            segmentElement.innerHTML = `
                <div class="segment-header">
                    <span class="segment-number">Chapter ${segmentNumber}</span>
                    ${influences.length > 0 ?
                        `<span class="active-influences">
                            Influenced by: ${influences.join(' | ')}
                        </span>` :
                        ''
                    }
                </div>
                ${imageUrl ?
                    `<div class="chapter-ornament">
                        <img src="${imageUrl}" alt="Chapter ${segmentNumber} ornament" loading="lazy" />
                    </div>` :
                    ''
                }
                ${storylineInfo}
                <div class="segment-content">${formatStoryText(segment, thinkSections)}</div>
            `;

            container.appendChild(segmentElement);

            // Initialize any new accordions (Bootstrap collapse functionality)
            if (thinkSections && thinkSections.length > 0) {
                setTimeout(() => {
                    thinkSections.forEach(thinkSection => {
                        const collapseId = `collapse_${thinkSection.id}`;
                        const collapseElement = document.getElementById(collapseId);
                        if (collapseElement) {
                            // Initialize Bootstrap Collapse
                            new bootstrap.Collapse(collapseElement, { toggle: false });

                            // Add click handler for accordion header
                            const headerElement = collapseElement.previousElementSibling;
                            if (headerElement && headerElement.classList.contains('accordion-header')) {
                                headerElement.addEventListener('click', function() {
                                    const icon = headerElement.querySelector('.accordion-icon');
                                    if (collapseElement.classList.contains('show')) {
                                        icon.style.transform = 'rotate(0deg)';
                                    } else {
                                        icon.style.transform = 'rotate(180deg)';
                                    }
                                });
                            }
                        }
                    });
                }, 100); // Small delay to ensure DOM is ready
            }

            // Smooth scroll to new segment
            segmentElement.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        // Display error message
        function displayError(message) {
            const container = document.getElementById('storyContainer');
            const errorElement = document.createElement('div');
            errorElement.className = 'story-segment error-segment';
            errorElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
            container.appendChild(errorElement);
        }

        // Enhanced loading messages with contextual feedback
        const loadingMessages = [
            'Weaving your tale...',
            'Adding character depth...',
            'Building suspense...',
            'Crafting dialogue...',
            'Setting the scene...',
            'Developing plot twists...',
            'Enhancing atmosphere...',
            'Generating next chapter...'
        ];

        let currentMessageIndex = 0;
        let messageInterval;

        // Show/hide loading with contextual messages
        function showLoadingSpinner(show) {
            const loader = document.getElementById('continueLoader');
            const message = document.getElementById('scrollMessage');

            if (show) {
                loader.style.display = 'block';
                currentMessageIndex = 0;
                updateLoadingMessage();

                // Cycle through messages every 2 seconds
                messageInterval = setInterval(updateLoadingMessage, 2000);
            } else {
                loader.style.display = 'none';
                message.textContent = 'Keep scrolling for more story...';
                if (messageInterval) {
                    clearInterval(messageInterval);
                    messageInterval = null;
                }
            }
        }

        // Update loading message with cycling content
        function updateLoadingMessage() {
            const message = document.getElementById('scrollMessage');
            message.textContent = loadingMessages[currentMessageIndex];
            currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
        }

        // Update initial loading message
        function updateInitialLoadingMessage(text, subtext = '') {
            const messageEl = document.getElementById('loadingMessage');
            const submessageEl = document.getElementById('loadingSubmessage');

            if (messageEl) messageEl.textContent = text;
            if (submessageEl && subtext) submessageEl.textContent = subtext;
        }

        // Setup scroll listener for infinite scroll
        function setupScrollListener() {
            let scrollTimeout;
            let scrollEventCount = 0;

            console.log('Setting up scroll listener...');

            window.addEventListener('scroll', () => {
                scrollEventCount++;
                console.log(`Scroll event #${scrollEventCount} fired`);

                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollTrigger = document.getElementById('scrollTrigger');
                    if (!scrollTrigger) {
                        console.warn('Scroll trigger element not found');
                        return;
                    }

                    const rect = scrollTrigger.getBoundingClientRect();
                    console.log('Scroll trigger position:', {
                        top: rect.top,
                        bottom: rect.bottom,
                        windowHeight: window.innerHeight,
                        isVisible: rect.top <= window.innerHeight && rect.bottom >= 0,
                        isLoading: isLoading,
                        hasStarted: hasStarted
                    });

                    // If scroll trigger is visible and we're not loading and not awaiting storyline selection
                    if (rect.top <= window.innerHeight && rect.bottom >= 0 && !isLoading && hasStarted && !awaitingSelection) {
                        console.log('Conditions met - calling continueStory()');
                        continueStory();
                    } else {
                        console.log('Conditions not met for continue story:', {
                            triggerVisible: rect.top <= window.innerHeight && rect.bottom >= 0,
                            notLoading: !isLoading,
                            storyStarted: hasStarted,
                            notAwaitingSelection: !awaitingSelection,
                            storyMode: storyMode
                        });
                    }
                }, 100);
            });
        }

        // Reset story
        async function resetStory() {
            if (isLoading) return;

            try {
                await fetch('/api/reset_story', {method: 'POST'});

                // Clear UI and restore initial state
                document.getElementById('storyContainer').innerHTML = `
                    <div class="story-segment loading-segment" id="loadingSegment">
                        <div class="text-center">
                            <div class="start-story-section">
                                <h3><i class="fas fa-magic"></i> Ready to Begin Your Adventure?</h3>
                                <p class="mb-4">Select story influences and character elements from the sidebar, then click below to generate your personalized story.</p>

                                <button class="btn btn-primary btn-lg" id="startStoryBtn" onclick="startStory()">
                                    <i class="fas fa-play-circle"></i> Generate Story
                                </button>

                                <div class="mt-4 text-muted small">
                                    <p><i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Try different combinations of influences for unique stories!</p>
                                </div>
                            </div>

                            <!-- Hidden loading state -->
                            <div class="generating-story-section" id="generatingStory" style="display: none;">
                                <div class="terminal-loader">
                                    <div class="terminal-cursor"></div>
                                    <div class="loading-dots">
                                        <span>></span>
                                        <span class="dot">.</span>
                                        <span class="dot">.</span>
                                        <span class="dot">.</span>
                                    </div>
                                </div>
                                <p class="loading-message" id="loadingMessage">Crafting your story...</p>
                                <p class="loading-submessage" id="loadingSubmessage">This may take a few moments</p>
                            </div>
                        </div>
                    </div>
                `;

                // Reset state
                hasStarted = false;

            } catch (error) {
                console.error('Error resetting story:', error);
                alert('Failed to reset story');
            }
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Allow Enter key to add badge
        document.getElementById('newBadgeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewBadge();
            }
        });
    </script>

</body>
</html>
